<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∏–µ–Ω—Ç—ã - ZAZA Admin</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="page-clients">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ZAZA</div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="/static/dashboard.html" class="nav-link">
                        <span>üè†</span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tgbot.html" class="nav-link">
                        <span>ü§ñ</span>
                        <span>–¢–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/employees.html" class="nav-link">
                        <span>üë•</span>
                        <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/clients.html" class="nav-link active">
                        <span>üë§</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tickets.html" class="nav-link">
                        <span>üéØ</span>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/archive.html" class="nav-link">
                        <span>üìã</span>
                        <span>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/chat.html" class="nav-link">
                        <span>üí¨</span>
                        <span>–ß–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/notes.html" class="nav-link">
                        <span>üìù</span>
                        <span>–ó–∞–º–µ—Ç–∫–∏</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <h1 id="page-title">–ö–ª–∏–µ–Ω—Ç—ã</h1>
        </div>
        
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
            <div class="user-menu">
                <button class="user-btn" id="profileBtn">
                    <span class="user-avatar">üë§</span>
                    <span id="username">Admin</span>
                </button>
            </div>
            <button class="btn btn-danger" id="logoutBtn">
                –í—ã–π—Ç–∏
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="loadClients()">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="loadingSpinner" class="loading-spinner">
                        <div class="spinner"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</span>
                    </div>
                    
                    <div id="clientsContent" style="display: none;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ò–º—è</th>
                                        <th>Telegram ID</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTableBody">
                                    <!-- –ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="emptyState" style="display: none; text-align: center; padding: 40px; color: #999;">
                        <h3>üë§ –ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                        <p>–ö–ª–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–º–∏ –ø–µ—Ä–≤—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ –≤ –±–æ—Ç–µ</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/base.js"></script>
    <script>
        let currentClients = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const token = getToken();
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }
            loadClients();
        });

        async function loadClients() {
            const spinner = document.getElementById('loadingSpinner');
            const content = document.getElementById('clientsContent');
            const emptyState = document.getElementById('emptyState');

            spinner.style.display = 'flex';
            content.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/static/login.html';
                    return;
                }

                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentClients = data.clients || [];
                
                displayClients(currentClients);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤');
                }
            } finally {
                spinner.style.display = 'none';
            }
        }

        function displayClients(clients) {
            const content = document.getElementById('clientsContent');
            const emptyState = document.getElementById('emptyState');
            const tbody = document.getElementById('clientsTableBody');

            if (clients.length === 0) {
                content.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            const rows = clients.map(client => `
                <tr>
                    <td>${client.id}</td>
                    <td>${client.first_name || client.telegram_username || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                    <td>${client.telegram_user_id}</td>
                    <td>
                        <span class="badge badge-info">
                            ${client.tickets_count}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge" style="background-color: ${client.is_blocked ? '#dc3545' : '#28a745'}; color: white;">
                            ${client.is_blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–Ω—ã–π'}
                        </span>
                    </td>
                    <td>${formatDate(client.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="viewClientDetails(${client.id})" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                                üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button class="btn btn-sm ${client.is_blocked ? 'btn-success' : 'btn-warning'}" 
                                    onclick="toggleClientBlock(${client.id}, '${client.is_blocked}')" 
                                    title="${client.is_blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}">
                                ${client.is_blocked ? 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
            content.style.display = 'block';
            emptyState.style.display = 'none';
        }

        function viewClientDetails(clientId) {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
            window.location.href = `/static/client-details.html?id=${clientId}`;
        }

        async function toggleClientBlock(clientId, isCurrentlyBlocked) {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ boolean
            const isBlocked = isCurrentlyBlocked === 'true' || isCurrentlyBlocked === true;
            const action = isBlocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?`)) {
                return;
            }

            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/static/login.html';
                    return;
                }

                const response = await fetch(`/api/clients/${clientId}/block`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showSuccess(result.message);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
                loadClients();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSuccess(message) {
            // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–µ)
            alert(message);
        }

        function showError(message) {
            // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–µ)
            alert(message);
        }

        function getToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('token');
        }
    </script>
</body>
</html>