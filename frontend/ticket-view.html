<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è - ZAZA Admin</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 10001;
        }

        .image-modal-close:hover {
            opacity: 0.7;
        }
        
        .media-message img {
            transition: transform 0.2s ease;
        }
        
        .media-message img:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="page-archive">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ZAZA</div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="/static/dashboard.html" class="nav-link">
                        <span>üè†</span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tgbot.html" class="nav-link">
                        <span>ü§ñ</span>
                        <span>–¢–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/employees.html" class="nav-link">
                        <span>üë•</span>
                        <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tickets.html" class="nav-link">
                        <span>üéØ</span>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/archive.html" class="nav-link active">
                        <span>üìã</span>
                        <span>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="chat">
                        <span>üí¨</span>
                        <span>–ß–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="notes">
                        <span>üìù</span>
                        <span>–ó–∞–º–µ—Ç–∫–∏</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="main-wrapper">
        <header class="header">
            <div class="header-left">
                <a href="/static/archive.html" class="btn btn-secondary" style="margin-right: 15px;">‚Üê –ù–∞–∑–∞–¥ –∫ –∞—Ä—Ö–∏–≤—É</a>
                <h1 id="page-title">üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è</h1>
            </div>
            
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <div class="user-menu">
                    <button class="user-btn" id="profileBtn">
                        <span class="user-avatar">üë§</span>
                        <span id="username">Admin</span>
                    </button>
                </div>
                <button class="btn btn-danger" id="logoutBtn">
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </header>

        <main class="main-content" id="mainContent">
            <div id="ticketContent">
                <div class="loading-row">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è...</div>
            </div>
        </main>
    </div>

    <!-- –û–±—â–∏–π JavaScript -->
    <script src="/static/base.js"></script>
    <script>
        let ticketId = null;
        let ticket = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–∏–∫–µ—Ç–∞ –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            ticketId = urlParams.get('id');
            
            if (!ticketId) {
                document.getElementById('ticketContent').innerHTML = 
                    '<div class="container"><div class="card"><div class="card-body" style="text-align: center; color: #d32f2f;">–ù–µ —É–∫–∞–∑–∞–Ω ID –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div></div>';
                return;
            }
            
            loadTicket();
        });

        async function loadTicket() {
            try {
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                ticket = await response.json();
                displayTicket(ticket);
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø—Ä–∏—à–ª–∏ —Å —Ç–∏–∫–µ—Ç–æ–º
                if (ticket.messages) {
                    displayMessages(ticket.messages);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–∞:', error);
                document.getElementById('ticketContent').innerHTML = 
                    '<div class="container"><div class="card"><div class="card-body" style="text-align: center; color: #d32f2f;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div></div>';
            }
        }

        function displayTicket(ticket) {
            const container = document.getElementById('ticketContent');
            
            const ticketHTML = `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2>–û–±—Ä–∞—â–µ–Ω–∏–µ #${ticket.id}</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table">
                                    <tbody>
                                        <tr>
                                            <th style="width: 150px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <td>
                                                <span class="status-badge" style="background-color: #f0f0f0; color: #333;">
                                                    ${getCategoryName(ticket.category)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–¢–µ–º–∞</th>
                                            <td>${ticket.subject || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                        </tr>
                                        <tr>
                                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                                            <td>@${ticket.telegram_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                        </tr>
                                        <tr>
                                            <th>Telegram ID</th>
                                            <td>${ticket.telegram_user_id}</td>
                                        </tr>
                                        <tr>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <td>
                                                <span class="status-badge" style="background-color: #f5f5f5; color: #666;">
                                                    ${getStatusName(ticket.status)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–†–µ—à–µ–Ω–∏–µ</th>
                                            <td>
                                                <span class="status-badge" style="background-color: ${getResolutionColor(ticket.resolution)}; color: white;">
                                                    ${getResolutionName(ticket.resolution)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                            <td>${formatDate(ticket.created_at)}</td>
                                        </tr>
                                        <tr>
                                            <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                                            <td>${formatDate(ticket.updated_at)}</td>
                                        </tr>
                                        ${ticket.note ? `
                                        <tr>
                                            <th>–ó–∞–º–µ—Ç–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</th>
                                            <td>
                                                <div style="padding: 10px; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                                                    ${ticket.note}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏</h2>
                        </div>
                        <div class="card-body">
                            <div id="messagesList">
                                <div class="loading-row">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = ticketHTML;
        }



        function displayMessages(messages) {
            const container = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }

            const messagesHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                <th style="width: 150px;">–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(message => `
                                <tr>
                                    <td>
                                        <span class="status-badge" style="background-color: ${message.is_from_admin ? '#f3e5f5' : '#e3f2fd'}; color: ${message.is_from_admin ? '#7b1fa2' : '#1976d2'};">
                                            ${message.is_from_admin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : `@${ticket.telegram_username || '–ö–ª–∏–µ–Ω—Ç'}`}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="word-wrap: break-word; max-width: 400px;">
                                            ${formatMessageContent(message)}
                                        </div>
                                    </td>
                                    <td>${formatDate(message.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = messagesHTML;
        }

        function formatMessageContent(message) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            if (message.message_type === 'photo') {
                if (message.local_file_path) {
                    const imagePath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <img src="/api/media/${imagePath}" 
                                 alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" 
                                 style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;" 
                                 onclick="openImageModal('/api/media/${imagePath}')"
                                 onerror="this.style.display='none'">
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                }
            }
            
            if (message.message_type === 'video') {
                if (message.local_file_path) {
                    const videoPath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <video controls style="max-width: 300px; max-height: 300px; border-radius: 8px;">
                                <source src="/api/media/${videoPath}" type="video/mp4">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                            </video>
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üé• –í–∏–¥–µ–æ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                }
            }
            
            if (message.message_type === 'document') {
                if (message.local_file_path) {
                    const docPath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <a href="/api/media/${docPath}" 
                               target="_blank" 
                               style="color: #007bff; text-decoration: none;">
                                üìÑ ${message.original_filename || '–î–æ–∫—É–º–µ–Ω—Ç'}
                            </a>
                            ${message.file_size ? `<div style="font-size: 0.9em; color: #999;">–†–∞–∑–º–µ—Ä: ${formatFileSize(message.file_size)}</div>` : ''}
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üìÑ –î–æ–∫—É–º–µ–Ω—Ç (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)</div>`;
                }
            }
            
            // –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (message.content) {
                return message.content.replace(/\n/g, '<br>');
            }
            
            return '<div style="color: #999; font-style: italic;">–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 –ë';
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getCategoryName(category) {
            const names = {
                'dispute': '–î–∏—Å–ø—É—Ç',
                'crypto_payment': '–ö—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–∞',
                'general': '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                'employment': '–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'
            };
            return names[category] || category;
        }

        function getStatusName(status) {
            const names = {
                'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'archive': '–ê—Ä—Ö–∏–≤'
            };
            return names[status] || status;
        }

        function getResolutionName(resolution) {
            const names = {
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'refuse': '–û—Ç–∫–∞–∑',
                'refund': '–í–æ–∑–≤—Ä–∞—Ç',
                'closed': '–ó–∞–∫—Ä—ã—Ç',
                'spam': '–°–ø–∞–º'
            };
            return names[resolution] || resolution;
        }

        function getResolutionColor(resolution) {
            const colors = {
                'in_work': '#28a745',
                'refuse': '#dc3545',
                'refund': '#6f42c1',
                'closed': '#17a2b8',
                'spam': '#fd7e14'
            };
            return colors[resolution] || '#6c757d';
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageSrc;
            modal.style.display = 'flex';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
    </div>
</body>
</html>