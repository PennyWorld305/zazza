<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è - ZAZA Admin</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="page-archive">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ZAZA</div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="/static/dashboard.html" class="nav-link">
                        <span>üè†</span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tgbot.html" class="nav-link">
                        <span>ü§ñ</span>
                        <span>–¢–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/employees.html" class="nav-link">
                        <span>üë•</span>
                        <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tickets.html" class="nav-link">
                        <span>üéØ</span>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/archive.html" class="nav-link active">
                        <span>üìã</span>
                        <span>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="chat">
                        <span>üí¨</span>
                        <span>–ß–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="notes">
                        <span>üìù</span>
                        <span>–ó–∞–º–µ—Ç–∫–∏</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="main-wrapper">
        <header class="header">
            <div class="header-left">
                <a href="/static/archive.html" class="btn btn-secondary" style="margin-right: 15px;">‚Üê –ù–∞–∑–∞–¥ –∫ –∞—Ä—Ö–∏–≤—É</a>
                <h1 id="page-title">üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è</h1>
            </div>
            
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <div class="user-menu">
                    <button class="user-btn" id="profileBtn">
                        <span class="user-avatar">üë§</span>
                        <span id="username">Admin</span>
                    </button>
                </div>
                <button class="btn btn-danger" id="logoutBtn">
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </header>

        <main class="main-content" id="mainContent">
            <div id="ticketContent">
                <div class="loading-row">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è...</div>
            </div>
        </main>
    </div>

    <!-- –û–±—â–∏–π JavaScript -->
    <script src="/static/base.js"></script>
    <script>
        let ticketId = null;
        let ticket = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–∏–∫–µ—Ç–∞ –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            ticketId = urlParams.get('id');
            
            if (!ticketId) {
                document.getElementById('ticketContent').innerHTML = 
                    '<div class="container"><div class="card"><div class="card-body" style="text-align: center; color: #d32f2f;">–ù–µ —É–∫–∞–∑–∞–Ω ID –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div></div>';
                return;
            }
            
            loadTicket();
        });

        async function loadTicket() {
            try {
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                ticket = await response.json();
                displayTicket(ticket);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–∞:', error);
                document.getElementById('ticketContent').innerHTML = 
                    '<div class="container"><div class="card"><div class="card-body" style="text-align: center; color: #d32f2f;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div></div></div>';
            }
        }

        function displayTicket(ticket) {
            const container = document.getElementById('ticketContent');
            
            const ticketHTML = `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h2>–û–±—Ä–∞—â–µ–Ω–∏–µ #${ticket.id}</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table">
                                    <tbody>
                                        <tr>
                                            <th style="width: 150px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <td>
                                                <span class="status-badge" style="background-color: #f0f0f0; color: #333;">
                                                    ${getCategoryName(ticket.category)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–¢–µ–º–∞</th>
                                            <td>${ticket.subject || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                        </tr>
                                        <tr>
                                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                                            <td>@${ticket.telegram_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                        </tr>
                                        <tr>
                                            <th>Telegram ID</th>
                                            <td>${ticket.telegram_user_id}</td>
                                        </tr>
                                        <tr>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <td>
                                                <span class="status-badge" style="background-color: #f5f5f5; color: #666;">
                                                    ${getStatusName(ticket.status)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–†–µ—à–µ–Ω–∏–µ</th>
                                            <td>
                                                <span class="status-badge" style="background-color: ${getResolutionColor(ticket.resolution)}; color: white;">
                                                    ${getResolutionName(ticket.resolution)}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                            <td>${formatDate(ticket.created_at)}</td>
                                        </tr>
                                        <tr>
                                            <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                                            <td>${formatDate(ticket.updated_at)}</td>
                                        </tr>
                                        ${ticket.note ? `
                                        <tr>
                                            <th>–ó–∞–º–µ—Ç–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</th>
                                            <td>
                                                <div style="padding: 10px; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                                                    ${ticket.note}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏</h2>
                        </div>
                        <div class="card-body">
                            <div id="messagesList">
                                <div class="loading-row">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = ticketHTML;
            loadMessages();
        }

        async function loadMessages() {
            try {
                const response = await fetch(`/api/tickets/${ticketId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const messages = await response.json();
                displayMessages(messages);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                document.getElementById('messagesList').innerHTML = 
                    '<div style="text-align: center; color: #d32f2f; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }

            const messagesHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                <th style="width: 150px;">–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(message => `
                                <tr>
                                    <td>
                                        <span class="status-badge" style="background-color: ${message.sender_type === 'client' ? '#e3f2fd' : '#f3e5f5'}; color: ${message.sender_type === 'client' ? '#1976d2' : '#7b1fa2'};">
                                            ${message.sender_type === 'client' ? `@${ticket.telegram_username || '–ö–ª–∏–µ–Ω—Ç'}` : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="word-wrap: break-word; max-width: 400px;">
                                            ${formatMessageContent(message.content)}
                                        </div>
                                    </td>
                                    <td>${formatDate(message.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = messagesHTML;
        }

        function formatMessageContent(content) {
            // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (!content) return '';
            
            // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br>
            content = content.replace(/\n/g, '<br>');
            
            // –ï—Å–ª–∏ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (content.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                return `<img src="${content}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 200px; max-height: 200px; border-radius: 4px;" onerror="this.style.display='none'">`;
            }
            
            return content;
        }

        function getCategoryName(category) {
            const names = {
                'dispute': '–î–∏—Å–ø—É—Ç',
                'crypto_payment': '–ö—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–∞',
                'general': '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                'employment': '–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'
            };
            return names[category] || category;
        }

        function getStatusName(status) {
            const names = {
                'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'archive': '–ê—Ä—Ö–∏–≤'
            };
            return names[status] || status;
        }

        function getResolutionName(resolution) {
            const names = {
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'refuse': '–û—Ç–∫–∞–∑',
                'refund': '–í–æ–∑–≤—Ä–∞—Ç'
            };
            return names[resolution] || resolution;
        }

        function getResolutionColor(resolution) {
            const colors = {
                'in_work': '#28a745',
                'refuse': '#dc3545',
                'refund': '#6f42c1'
            };
            return colors[resolution] || '#6c757d';
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>