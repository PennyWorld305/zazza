<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ - ZAZA Admin</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 10001;
        }

        .image-modal-close:hover {
            opacity: 0.7;
        }
        
        .media-message img {
            transition: transform 0.2s ease;
        }
        
        .media-message img:hover {
            transform: scale(1.05);
            cursor: pointer;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü */
        .data-table th {
            color: #495057 !important;
            background-color: #f8f9fa !important;
            font-weight: 600 !important;
            border: 1px solid #dee2e6 !important;
        }
        
        /* –î–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        body.dark-theme .data-table th {
            color: #e9ecef !important;
            background-color: #495057 !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .statistics-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .statistics-container h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .stats-column h4 {
            margin-bottom: 10px;
            color: #6c757d;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
        }

        .stat-value {
            font-weight: bold;
            color: #007bff;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-btn, .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-decoration: none;
        }

        .current-page {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        .pagination-info {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .ticket-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .ticket-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ticket-body {
            padding: 15px;
        }

        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            background: #fafafa;
        }

        .message-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.8em;
            color: #666;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .statistics-container {
            margin: 20px 0;
        }

        .stats-row {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stats-column {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stats-column h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #495057;
        }

        .stat-value {
            font-weight: bold;
            color: #007bff;
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination-btn {
            min-width: 120px;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-btn {
            min-width: 40px;
            height: 40px;
        }

        .current-page {
            background: #007bff;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        body.dark-theme .stats-column {
            background: #495057;
            border-color: #6c757d;
        }

        body.dark-theme .stats-column h4 {
            color: #e9ecef;
        }

        body.dark-theme .stat-item {
            border-bottom-color: #6c757d;
        }

        body.dark-theme .stat-label {
            color: #e9ecef;
        }
    </style>
</head>
<body class="page-client-details">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ZAZA</div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="/static/dashboard.html" class="nav-link">
                        <span>üè†</span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tgbot.html" class="nav-link">
                        <span>ü§ñ</span>
                        <span>–¢–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/employees.html" class="nav-link">
                        <span>üë•</span>
                        <span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/clients.html" class="nav-link active">
                        <span>üë§</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/tickets.html" class="nav-link">
                        <span>üéØ</span>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/archive.html" class="nav-link">
                        <span>üìã</span>
                        <span>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/chat.html" class="nav-link">
                        <span>üí¨</span>
                        <span>–ß–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/static/notes.html" class="nav-link">
                        <span>üìù</span>
                        <span>–ó–∞–º–µ—Ç–∫–∏</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <h1 id="page-title">–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞</h1>
        </div>
        
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
            <div class="user-menu">
                <button class="user-btn" id="profileBtn">
                    <span class="user-avatar">üë§</span>
                    <span id="username">Admin</span>
                </button>
            </div>
            <button class="btn btn-danger" id="logoutBtn">
                –í—ã–π—Ç–∏
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner"></div>
                <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞...</span>
            </div>
            
            <div id="clientContent" style="display: none;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-secondary" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button> 
                        <h2>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h2>
                    </div>
                    <div class="card-body" id="clientInfo">
                        <!-- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="card">
                    <div class="card-body" id="clientStatistics">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <!-- –¢–∏–∫–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ -->
                <div class="card">
                    <div class="card-header">
                        <h2>üéØ –¢–∏–∫–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞</h2>
                    </div>
                    <div class="card-body" id="clientTickets">
                        <!-- –¢–∏–∫–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div class="card-footer" id="ticketsPagination">
                        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/base.js"></script>
    <script>
        let clientId = null;
        let clientData = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const token = getToken();
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º ID –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            clientId = urlParams.get('id');
            
            if (!clientId) {
                alert('ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
                goBack();
                return;
            }

            loadClientDetails();
        });

        let currentPage = 1;
        const itemsPerPage = 10;

        async function loadClientDetails(page = 1) {
            const spinner = document.getElementById('loadingSpinner');
            const content = document.getElementById('clientContent');

            spinner.style.display = 'flex';
            content.style.display = 'none';

            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/static/login.html';
                    return;
                }

                const response = await fetch(`/api/clients/${clientId}?page=${page}&limit=${itemsPerPage}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                currentPage = page;

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                clientData = data;
                
                displayClientInfo(data.client);
                displayStatistics(data.statistics);
                displayClientTickets(data.tickets);
                displayPagination(data.pagination);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞:', error);
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    window.location.href = '/static/login.html';
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞');
                    goBack();
                }
            } finally {
                spinner.style.display = 'none';
                content.style.display = 'block';
            }
        }

        function displayClientInfo(client) {
            const container = document.getElementById('clientInfo');
            
            const html = `
                <div class="table-container">
                    <table class="data-table">
                        <tbody>
                            <tr>
                                <th style="width: 200px;">Telegram Username</th>
                                <td>@${client.telegram_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                            </tr>
                            <tr>
                                <th>Telegram ID</th>
                                <td>${client.telegram_user_id}</td>
                            </tr>
                            <tr>
                                <th>–ò–º—è</th>
                                <td>${client.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                            </tr>
                            
                            <tr>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <td>
                                    <span class="status-badge" style="background-color: ${client.is_blocked ? '#dc3545' : '#28a745'}; color: white;">
                                        ${client.is_blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–Ω—ã–π'}
                                    </span>
                                    <button class="btn btn-sm ${client.is_blocked ? 'btn-success' : 'btn-warning'}" 
                                            onclick="toggleClientBlock(${client.id}, '${client.is_blocked}')"
                                            style="margin-left: 10px;">
                                        ${client.is_blocked ? 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                <td>${formatDate(client.created_at)}</td>
                            </tr>
                            <tr>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
                                <td>${formatDate(client.updated_at)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayStatistics(statistics) {
            const container = document.getElementById('clientStatistics');
            
            const categoryNames = {
                'dispute': '–î–∏—Å–ø—É—Ç—ã',
                'crypto_payment': '–ö—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–∞',
                'general': '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                'employment': '–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'
            };
            
            const resolutionNames = {
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'refuse': '–û—Ç–∫–∞–∑',
                'refund': '–í–æ–∑–≤—Ä–∞—Ç',
                'closed': '–ó–∞–∫—Ä—ã—Ç–æ',
                'spam': '–°–ø–∞–º',
                // –°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                'resolved': '–†–µ—à–µ–Ω–æ',
                'refunded': '–í–æ–∑–≤—Ä–∞—Ç', 
                'rejected': '–û—Ç–∫–∞–∑'
            };

            let categoryStatsHtml = '';
            if (statistics.categories && Object.keys(statistics.categories).length > 0) {
                categoryStatsHtml = Object.entries(statistics.categories).map(([category, count]) => 
                    `<div class="stat-item">
                        <span class="stat-label">${categoryNames[category] || category}:</span>
                        <span class="stat-value">${count}</span>
                    </div>`
                ).join('');
            } else {
                categoryStatsHtml = '<div class="stat-item">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>';
            }

            let resolutionStatsHtml = '';
            if (statistics.resolutions && Object.keys(statistics.resolutions).length > 0) {
                resolutionStatsHtml = Object.entries(statistics.resolutions).map(([resolution, count]) => 
                    `<div class="stat-item">
                        <span class="stat-label">${resolutionNames[resolution] || resolution}:</span>
                        <span class="stat-value">${count}</span>
                    </div>`
                ).join('');
            } else {
                resolutionStatsHtml = '<div class="stat-item">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤</div>';
            }

            const html = `
                <div class="statistics-container">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤</h3>
                    <div class="stats-row">
                        <div class="stats-column">
                            <h4>–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h4>
                            ${categoryStatsHtml}
                        </div>
                        <div class="stats-column">
                            <h4>–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º:</h4>
                            ${resolutionStatsHtml}
                        </div>
                        <div class="stats-column">
                            <div class="stat-item">
                                <span class="stat-label">–í—Å–µ–≥–æ —Ç–∏–∫–µ—Ç–æ–≤:</span>
                                <span class="stat-value">${statistics.total_tickets || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayClientTickets(tickets) {
            const container = document.getElementById('clientTickets');
            
            if (tickets.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">–£ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</div>';
                return;
            }

            const ticketsHtml = tickets.map(ticket => `
                <div class="ticket-card">
                    <div class="ticket-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4>–¢–∏–∫–µ—Ç #${ticket.id} - ${ticket.subject || '–ë–µ–∑ —Ç–µ–º—ã'}</h4>
                                <p style="margin: 5px 0; color: #666;">
                                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <strong>${getCategoryName(ticket.category)}</strong> | 
                                    –°—Ç–∞—Ç—É—Å: <span class="status-badge" style="background-color: ${getStatusColor(ticket.status)}; color: white; padding: 2px 8px; border-radius: 4px;">
                                        ${getStatusName(ticket.status)}
                                    </span> |
                                    –†–µ—à–µ–Ω–∏–µ: <span class="status-badge" style="background-color: ${getResolutionColor(ticket.resolution)}; color: white; padding: 2px 8px; border-radius: 4px;">
                                        ${getResolutionName(ticket.resolution)}
                                    </span>
                                </p>
                            </div>
                            <div style="text-align: right; color: #666;">
                                <div>–°–æ–∑–¥–∞–Ω: ${formatDate(ticket.created_at)}</div>
                                <div>–û–±–Ω–æ–≤–ª–µ–Ω: ${formatDate(ticket.updated_at)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="ticket-body">
                        <div style="margin-bottom: 15px;">
                            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                            <p>${ticket.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        </div>
                        
                        ${ticket.note ? `
                        <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                            <strong>–ó–∞–º–µ—Ç–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</strong>
                            <p style="margin: 5px 0 0 0;">${ticket.note}</p>
                        </div>
                        ` : ''}
                        
                        <div>
                            <strong>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (${ticket.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π):</strong>
                            <div class="messages-container">
                                ${displayMessages(ticket.messages)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = ticketsHtml;
        }

        function displayPagination(pagination) {
            const container = document.getElementById('ticketsPagination');
            
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHtml = '<div class="pagination-container">';
            
            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            if (pagination.page > 1) {
                paginationHtml += `<button class="btn btn-secondary pagination-btn" onclick="loadClientDetails(${pagination.page - 1})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
            }
            
            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            paginationHtml += '<div class="page-numbers">';
            
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    paginationHtml += `<span class="current-page">${i}</span>`;
                } else {
                    paginationHtml += `<button class="btn btn-outline-primary page-btn" onclick="loadClientDetails(${i})">${i}</button>`;
                }
            }
            
            paginationHtml += '</div>';
            
            // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
            if (pagination.page < pagination.pages) {
                paginationHtml += `<button class="btn btn-secondary pagination-btn" onclick="loadClientDetails(${pagination.page + 1})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
            }
            
            paginationHtml += '</div>';
            paginationHtml += `<div class="pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${pagination.pages} (–≤—Å–µ–≥–æ —Ç–∏–∫–µ—Ç–æ–≤: ${pagination.total})</div>`;
            
            container.innerHTML = paginationHtml;
        }

        function displayMessages(messages) {
            if (messages.length === 0) {
                return '<div style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            }

            return messages.map(message => `
                <div class="message-item">
                    <div class="message-sender" style="color: ${message.is_from_admin ? '#7b1fa2' : '#1976d2'};">
                        ${message.is_from_admin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : `@${clientData.client.telegram_username || '–ö–ª–∏–µ–Ω—Ç'}`}
                    </div>
                    <div class="message-content">
                        ${formatMessageContent(message)}
                    </div>
                    <div class="message-time">
                        ${formatDate(message.created_at)}
                    </div>
                </div>
            `).join('');
        }

        function formatMessageContent(message) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            if (message.message_type === 'photo') {
                if (message.local_file_path) {
                    const imagePath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <img src="/api/media/${imagePath}" 
                                 alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" 
                                 style="max-width: 250px; max-height: 200px; border-radius: 8px; cursor: pointer;" 
                                 onclick="openImageModal('/api/media/${imagePath}')"
                                 onerror="this.style.display='none'">
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                }
            }
            
            if (message.message_type === 'video') {
                if (message.local_file_path) {
                    const videoPath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <video controls style="max-width: 250px; max-height: 200px; border-radius: 8px;">
                                <source src="/api/media/${videoPath}" type="video/mp4">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                            </video>
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üé• –í–∏–¥–µ–æ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                }
            }
            
            if (message.message_type === 'document') {
                if (message.local_file_path) {
                    const docPath = message.local_file_path.replace(/\\/g, '/');
                    return `
                        <div class="media-message">
                            <a href="/api/media/${docPath}" 
                               target="_blank" 
                               style="color: #007bff; text-decoration: none;">
                                üìÑ ${message.original_filename || '–î–æ–∫—É–º–µ–Ω—Ç'}
                            </a>
                            ${message.file_size ? `<div style="font-size: 0.9em; color: #999;">–†–∞–∑–º–µ—Ä: ${formatFileSize(message.file_size)}</div>` : ''}
                            ${message.content ? `<div style="margin-top: 8px; color: #666;">${message.content.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `<div style="color: #999; font-style: italic;">üìÑ –î–æ–∫—É–º–µ–Ω—Ç (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)</div>`;
                }
            }
            
            // –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (message.content) {
                return message.content.replace(/\n/g, '<br>');
            }
            
            return '<div style="color: #999; font-style: italic;">–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 –ë';
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageSrc;
            modal.style.display = 'flex';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });

        async function toggleClientBlock(clientId, isCurrentlyBlocked) {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ boolean
            const isBlocked = isCurrentlyBlocked === 'true' || isCurrentlyBlocked === true;
            const action = isBlocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/clients/${clientId}/block`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert(result.message);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                loadClientDetails();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞');
            }
        }

        function getCategoryName(category) {
            const names = {
                'dispute': '–î–∏—Å–ø—É—Ç',
                'crypto_payment': '–ö—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–∞',
                'general': '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                'employment': '–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'
            };
            return names[category] || category;
        }

        function getStatusName(status) {
            const names = {
                'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'archive': '–ê—Ä—Ö–∏–≤'
            };
            return names[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'active': '#28a745',
                'in_work': '#ffc107',
                'archive': '#6c757d'
            };
            return colors[status] || '#6c757d';
        }

        function getResolutionName(resolution) {
            const names = {
                'in_work': '–í —Ä–∞–±–æ—Ç–µ',
                'refuse': '–û—Ç–∫–∞–∑',
                'refund': '–í–æ–∑–≤—Ä–∞—Ç',
                'closed': '–ó–∞–∫—Ä—ã—Ç–æ',
                'spam': '–°–ø–∞–º'
            };
            return names[resolution] || resolution;
        }

        function getResolutionColor(resolution) {
            const colors = {
                'in_work': '#28a745',
                'refuse': '#dc3545',
                'refund': '#6f42c1',
                'closed': '#17a2b8',
                'spam': '#fd7e14'
            };
            return colors[resolution] || '#6c757d';
        }

        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function goBack() {
            window.location.href = '/static/clients.html';
        }

        function getToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('token');
        }
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
    </div>
</body>
</html>